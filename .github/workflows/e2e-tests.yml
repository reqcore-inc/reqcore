name: E2E Tests

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

concurrency:
  group: e2e-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    name: Playwright E2E
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: reqcore
          POSTGRES_PASSWORD: reqcore-ci
          POSTGRES_DB: reqcore
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U reqcore -d reqcore"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

    env:
      DATABASE_URL: postgresql://reqcore:reqcore-ci@localhost:5432/reqcore
      BETTER_AUTH_SECRET: ci-test-secret-that-is-at-least-32-chars-long
      BETTER_AUTH_URL: http://localhost:3000
      NUXT_PUBLIC_SITE_URL: http://localhost:3000
      # S3 is optional â€” tests don't upload files, but the env vars must exist
      S3_ENDPOINT: http://localhost:9000
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: minioadmin
      S3_BUCKET: reqcore
      S3_REGION: us-east-1
      S3_FORCE_PATH_STYLE: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Push database schema
        run: npx drizzle-kit push

      - name: Build Nuxt application
        run: npm run build

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Start application server
        run: node .output/server/index.mjs &
        env:
          PORT: 3000
          NODE_ENV: production

      - name: Wait for server to be ready
        run: npx wait-on http://localhost:3000 --timeout 30000

      - name: Run Playwright tests
        id: playwright
        run: npx playwright test
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: test-results
          path: test-results/
          retention-days: 14

      # â”€â”€ Allure Report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get previous workflow run ID
        id: get_previous_run
        run: |
          PREVIOUS_RUN_ID=$(gh api \
            "repos/${{ github.repository }}/actions/workflows/e2e-tests.yml/runs?status=success&per_page=5" \
            --jq "[.workflow_runs[] | select(.id != ${{ github.run_id }})] | first | .id // empty")
          echo "run_id=${PREVIOUS_RUN_ID}" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true # no previous run on first execution

      - name: Download previous Allure history
        uses: actions/download-artifact@v4
        if: steps.get_previous_run.outputs.run_id != ''
        with:
          name: allure-history
          path: allure-results/history
          run-id: ${{ steps.get_previous_run.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true # first run won't have history yet

      - name: Generate Allure report
        if: ${{ !cancelled() }}
        run: npx allure generate allure-results --clean -o allure-report

      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: allure-results
          path: allure-results/
          retention-days: 30

      - name: Upload Allure report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

      - name: Save Allure history for trend tracking
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: allure-history
          path: allure-report/history/
          retention-days: 90
          overwrite: true

      - name: E2E Test Summary
        if: ${{ !cancelled() }}
        run: |
          echo "## E2E Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ steps.playwright.outcome }}" = "success" ]; then
            echo "âœ… **All Playwright tests passed**" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âŒ **Playwright tests failed**" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "| Report | Link |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Playwright HTML | ðŸ“¦ Download \`playwright-report\` artifact |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Allure Dashboard | ðŸ“¦ Download \`allure-report\` artifact or view on [GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/) |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "_Run: \`${{ github.run_id }}\` Â· Commit: \`${{ github.sha }}\`_" >> "$GITHUB_STEP_SUMMARY"
