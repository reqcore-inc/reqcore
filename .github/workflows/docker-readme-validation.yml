name: Docker README Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: docker-readme-validation-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  docker-readme-validation:
    name: Validate README Docker installation flow
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Prepare .env from README flow
        run: |
          cp .env.example .env
          BETTER_AUTH_SECRET_VALUE="$(openssl rand -base64 48 | tr -d '\n')"
          if grep -q '^BETTER_AUTH_SECRET=' .env; then
            sed -i "s|^BETTER_AUTH_SECRET=.*|BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET_VALUE}|" .env
          else
            echo "BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET_VALUE}" >> .env
          fi

      - name: Start Docker services
        run: docker compose up -d

      - name: Show Docker status (README parity)
        run: docker compose ps

      - name: Wait for Docker services
        run: |
          set -euo pipefail

          wait_for_service_state() {
            service="$1"
            expected_state="$2"
            timeout_seconds="$3"

            started_at="$(date +%s)"
            while true; do
              container_id="$(docker compose ps -q "$service")"
              if [ -n "$container_id" ]; then
                current_state="$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}{{.State.Status}}{{end}}' "$container_id")"
                echo "$service state: $current_state"
                if [ "$current_state" = "$expected_state" ]; then
                  break
                fi
              fi

              now="$(date +%s)"
              elapsed="$((now - started_at))"
              if [ "$elapsed" -ge "$timeout_seconds" ]; then
                echo "Timed out waiting for $service to become $expected_state"
                docker compose ps
                docker compose logs --no-color "$service" || true
                exit 1
              fi
              sleep 3
            done
          }

          wait_for_service_state db healthy 180
          wait_for_service_state minio healthy 180
          wait_for_service_state adminer running 120

      - name: Install dependencies (README parity)
        run: npm install

      - name: Start app and verify readiness
        run: |
          set -euo pipefail

          npm run dev -- --host 0.0.0.0 > dev.log 2>&1 &
          echo $! > dev.pid

          for _ in $(seq 90); do
            if curl -fsS http://localhost:3000 > /dev/null || curl -fsS http://127.0.0.1:3000 > /dev/null; then
              echo "Nuxt dev server is reachable on http://localhost:3000"
              exit 0
            fi

            if [ -f dev.pid ] && ! kill -0 "$(cat dev.pid)" 2>/dev/null; then
              echo "Nuxt dev server exited before readiness"
              tail -n 200 dev.log || true
              exit 1
            fi

            sleep 2
          done

          echo "Nuxt dev server did not become reachable in time"
          tail -n 200 dev.log || true
          exit 1

      - name: Dump logs and cleanup
        if: always()
        run: |
          docker compose ps || true
          docker compose logs --no-color --tail=300 || true

          if [ -f dev.log ]; then
            tail -n 300 dev.log || true
          fi

          if [ -f dev.pid ] && kill -0 "$(cat dev.pid)" 2>/dev/null; then
            kill "$(cat dev.pid)" || true
          fi

          docker compose down -v || true